---
title: "Covid ShinyApp"
author: "Makivic Bojan, MMSc"
---

```{r setup}
knitr::opts_chunk$set(echo = TRUE)
```

## Libraries

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(rvest)
library(stringr)
library(rebus)
library(lubridate)
library(shiny)
library(shinythemes)
library(countrycode)
library(plyr)
library(ggrepel)
library(rsconnect)
library(ggplot2)
library(dplyr)
library(plotly)
library(flexdashboard)
library(maps)
library(shinydashboard)
library(png)
library(sunburstR)
library(rmapshaper)
library(knitr)
library(rvest)
library(sf)
library(raster)
library(spData)
library(tmap)
library(rgdal)
library(highcharter)
```

## DATA PREPARATION

You can also embed plots, for example:

```{r echo=TRUE, message=FALSE, warning=FALSE}
# scraping data
url <- read_html("https://www.worldometers.info/coronavirus/")

# FIrST DATAFRAME
# dataframe of first table from url
df <- url %>%
  html_nodes("table") %>%
  .[[1]] %>%
  html_table()

df<- df[-c(1,15,17,18,19)] # remove last three colums

# remove special characters from dataframe
df <- df %>% mutate_all(funs(gsub("[[:punct:]]", "", .))) 

# return columns from 3 to 12 as integer
i <- c(2,3, 4, 5, 6, 7, 8, 9, 10, 11, 12,13)
df[, i] <-
  apply(df[, i], 2, function(x) {
    as.integer(as.character(x))
  })

df[is.na(df)] <- 0

names(df)[1] <- "Country"
names(df)[9:13] <- c("Serious", "Cases_1M", "Deaths_1M", "Total_Tests", "Tests_1M")

no <-
  c(
    "Diamond Princess",
    "MS Zaandam",
    "St Barth",
    "Total",
    "World",
    "All",
    "North America",
    "South America",
    "Asia",
    "Africa",
    "Oceania",
    "Europe",
    ""
  )
dfnoco <- filter(df, !df$Country %in% no)
df <- filter(df, !df$Country %in% no[no == "Total"])
dfnoco$countryCode <-
  countrycode(dfnoco$Country, origin = "country.name", destination = "iso3c")


# converting NA values into O

dfnoco[is.na(dfnoco)] <- 0

old <- c("CAR", 
         "Czechia", 
         "GuineaBissau",
         "Vatican City",
         "S Korea", 
         "UAE",
         "UK",
         "USA",
         "Congo",
         "DRC",
         "Saint Kitts and Nevis")
new <- c("Central African Republic", 
         "Czech Republic", 
         "Guinea-Bissau",
         "Vatican",
         "South Korea",
         "United Arab Emirates",
         "United Kingdom",
         "United States",
         "Republic of the Congo",
         "DR Congo",
         "Saint Kittis and Nevis")

for (i in 1:length(old)) {
  dfnoco$Country<- gsub(old[i],new[i],dfnoco$Country)
}

# SECOND DATAFRAME
url2 <-
  read_html("https://www.worldometers.info/coronavirus/worldwide-graphs/#case-timeline")

df_url2 <- url2 %>%
  html_nodes("table") %>%
  .[[1]] %>%
  html_table()
df_url2 <- df_url2[nrow(df_url2):1, ]
names(df_url2)[2:4] <-
  c(
    "Total deaths cumulative",
    "Daily deaths",
    "% increase in daily deaths"
  )

# remove special characters from dataframe
df_url2 <- df_url2  %>% mutate_all(funs(gsub("[[:punct:]]", "", .))) 
invisible(format(df_url2, justify = "left"))
df_url2[, 2:4] <-
  apply(df_url2[, 2:4], 2, function(x) {
    as.integer(as.character(x))
  }) 


df_url2$Date <- factor(df_url2$Date, levels = df_url2$Date)

# converting NA values into O
df_url2[is.na(df_url2)] <- 0

# THIRD DATAFRAME
url3 <-
  read_html("https://www.worldometers.info/world-population/population-by-country/") # Population
df_url3 <- url3 %>%
  html_nodes("table") %>%
  .[[1]] %>%
  html_table()
df_url3 <-
  df_url3 %>% mutate_all(funs(gsub("[[:punct:]]", "", .))) # clean special signs except letters, numbers, . and -
df_url3 <-
  df_url3[-c(0, 1, 4, 5, 8, 9)] # drop colums by index number
names(df_url3)[1:6] <-
  c(
    "Country",
    "Population",
    "Pop_density",
    "Land_area",
    "Median_age",
    "Urban_pop"
  )

# return columns from 2 to 6 as integer
df_url3[, 2:6] <-
  apply(df_url3[, 2:6], 2, function(x) {
    as.integer(as.character(x))
  })
df_url3$countryCode <-
  countrycode(df_url3$Country, origin = "country.name", destination = "iso3c")
df_url3[is.na(df_url3)] <- 0

old<- c("GuineaBissau",
        "Czech Republic Czechia",
        "Holy See", 
        "Saint Kittis  Nevis", 
        "Saint Pierre  Miquelon",
        "Sao Tome  Principe",
        "St Vincent  Grenadines",
        "State of Palestine",
        "Wallis  Futuna",
        "Côte dIvoire",
        "DR Congo\\b",
        "Congo\\b")
new<- c("Guinea-Bissau",
        "Czech Republic",
        "Vatican",
        "Saint Kittis and Nevis", 
        "Saint Pierre Miquelon",
        "Sao Tome and Principe",
        "St Vincent Grenadines",
        "Palestine",
        "Wallis and Futuna",
        "Ivory Coast",
        "DR Congo",
        "Republic of the Congo")
for (i in 1:length(old)) {
  df_url3$Country<- gsub(old[i],new[i],df_url3$Country)
}

# df 4
k <- c(2, 9, 10)
df_4 <- world[, k]
names(df_4)[1] <- c("Country")
df_4[is.na(df_4)] <- 0

old<- c("eSwatini", 
        "Dem. Rep. Korea",
        "Lao PDR", 
        "Macedonia",
        "The Gambia",
        "Timor-Leste",
        "Russian Federation",
        "Republic of Korea",
        "Democratic Republic of the Congo",
        "Côte d'Ivoire")
new<- c("Eswatini", 
        "North Korea",
        "Laos", 
        "North Macedonia",
        "Gambia",
        "TimorLeste",
        "Russia",
        "South Korea",
        "DR Congo",
        "Ivory Coast")
for (i in 1:length(old)) {
  df_4$Country<- gsub(old[i],new[i],df_4$Country)
}

join <-
  merge(dfnoco, df_4, by = "Country", all = TRUE) # merge df and df_url3 dataframes in one
join<- join[c(-15)]
join2 <-
  merge(join, df_url3, by = "Country", all = TRUE)
names(join2)[13] <- c("Tests_1M")
join2[, c(2:13)] <-
  apply(join2[, c(2:13)], 2, function(x) {
    as.integer(as.character(x))
  })

join2[is.na(join2)] <- 0

# Map view 2

fName <- "TM_WORLD_BORDERS-0.3.shp"

states <- st_read(dsn = fName)
names(states)[3]<- "countryCode"

data_full_states <- states %>%
  left_join(dfnoco, by = "countryCode")

data_full_states <- data_full_states %>% 
  left_join(df_url3, by = "countryCode")

```

## DF for Box plot
```{r}
df_con<- dfnoco[8:222,]
df_con$Total_Tests <- as.numeric(df_con$Total_Tests)
df_con$Tests_1M <- as.numeric(df_con$Tests_1M)
```


## Function to plot regression with summary data
```{r echo=TRUE}
ggplotRegression <- function(fit) {
  require(ggplot2)
  ggplot(fit$model, aes_string(
    x = names(fit$model)[2],
    y = names(fit$model)[1],
    label = names(fit$model)[3]
  )) +
    geom_point(na.rm = TRUE) +
    labs(x = paste(names(fit$model)[2]), y = paste(names(fit$model)[1])) +
    stat_smooth(method = "lm") +
    labs(title = paste(
      "R2 =",
      signif(summary(fit)$r.squared, 2),
      " Slope =",
      signif(fit$coef[[2]], 2),
      " P =",
      signif(summary(fit)$coef[2, 4], 2)
    ))
}
```


## Mapping option optimization

```{r Mapping option optimization, echo=TRUE}
Co <- as.list(df$TotalCases)
names(Co) <- df$Country

country_line_color <- list(color = toRGB("gray"), width = 1.2)
map_options <- list(
  showframe = FALSE,
  showcoastlines = FALSE,
  projection = list(type = "Mercator")
)

y <- df$NewCases[df$NewCases > 0]
df2 <- filter(df, df$NewCases > 0)
x <-
  factor(df2$Country, levels = unique(df2$Country)[order(y,
    decreasing =
      TRUE
  )])
```


## Define UI 
```{r, echo=TRUE}
ui <- shinyUI(dashboardPage(
  dashboardHeader(title = "SARS-CoV 2"),
  dashboardSidebar(
    sidebarMenu(
      menuItem(
        "Dashboard",
        tabName = "MainTab",
        icon = icon("dashboard")
      ),
      menuSubItem(
        "New cases",
        tabName = "NewCases",
        icon = icon("bar-chart-o")
      ),
      menuSubItem(
        "Map view 1",
        tabName = "TotalCases",
        icon = icon("chart-line")
      ),
      menuSubItem(
        "Map view 2",
        tabName = "TotalCases2",
        icon = icon("chart-line")
      ),
      menuSubItem("Total Deaths",
        tabName = "TotalDeaths", icon =
          icon("skull")
      ),
      menuSubItem("Box plot",
        tabName = "Boxplot", icon =
          icon("box")
      ),
      menuSubItem("SunBurst Graph", tabName = "SunBurst", icon = icon("sun")),
      menuSubItem("Daily deaths",
        tabName = "DailyDeaths", icon =
          icon("skull")
      ),
      menuSubItem(
        "Regression analysis",
        tabName = "Dens",
        icon = icon("bar-chart-o")
      )
    )
  ),
  dashboardBody(
    tabItems(
      tabItem(
        tabName = "MainTab",
        fluidPage(
          theme = shinytheme("flatly"),
          fluidRow(
            column(10, titlePanel("PLEASE CHOOSE THE DASHBOARD FROM THE SIDEBAR MENU"), align = "center")
          ),
          fluidRow(column(12, plotOutput(outputId = "png"))),
          fluidRow(column(6, titlePanel(h3("Credit: Bojan Makivic, MMSc")), style = "height:0px"))
        )
      ),
      tabItem(
        tabName = "NewCases",
        fluidPage(
          fluidRow(column(12,
            h1("New cases of Covid-19 for the current day"),
            style = "height:130px", align = "center"
          )),
          fluidRow(column(
            12,
            highchartOutput("plotDist")
          ))
        )
      ),
      tabItem(
        tabName = "TotalCases",
        fluidPage(
          fluidRow(
            column(6,
              theme = shinytheme("cerulean"),
              infoBox("Total cases world wide", df$TotalCases[df$Country == "World"], width = "100%"),
              icon = icon("chart-line"),
              infoBoxOutput("infoBox")
            ),
            column(
              3,
              selectInput("var", "Select continent:",
                choices =
                  Co[df$Country[1:6]]
              )
            ),
            column(3, gaugeOutput("table"), style = "height:20px")
          ),

          fluidRow(
            column(
              6,
              selectInput("par_M", "Select variable:", choices = colnames(dfnoco[c(3, 6:10, 13, 14)]))
            )
          ),
          fluidRow(column(
            12,

            plotlyOutput("geo", width = "100%", height = "100%")
          ))
        )
      ),
      tabItem(
        tabName = "TotalCases2",

        fluidPage(
          tmapOutput("geo2", width = "100%", height = 600)
        )
      ),
      tabItem(
        tabName = "TotalDeaths",
        fluidPage(
          fluidRow(
            column(4,
              style = "height:150px",
              infoBox("Total deaths world", df$TotalDeaths[df$Country == "World"], width = "100%"),
              icon = icon("chart-line")
            ),
            column(6, h1("Total deaths by country"))
          ),
          fluidPage(
            highchartOutput("plotDist2", height = 445)
          )
        )
      ),
      tabItem(
        tabName = "Boxplot",
        fluidPage(
          fluidRow(
            column(12,
              align = "center",
              icon = icon("box"),
              titlePanel(h1("Boxplot"))
            )
          ),
          fluidRow(column(9), column(
            3,
            selectInput("Box_par", "Select variable:", choices = colnames(dfnoco[c(3, 6:10, 13, 14)]))
          )),
          fluidPage(
            column(12, highchartOutput("Boxplot1"), style = "height:140px")
          )
        )
      ),
      tabItem(
        tabName = "SunBurst",
        absolutePanel(
          top = 40,
          left = 1100,
          style = "color: red",
          titlePanel(
            h5(
              "Hover with the mouse coursor over the specific parameter, e.g. active cases,
                                                         and click on it in order to reveal an additional information."
            )
          )
        ),
        titlePanel(h1("SunBurst graph", align = "center")),
        absolutePanel(
          top = 110,
          left = 250,
          draggable = FALSE,
          selectInput("var1", "Select country:",
            choices =
              df$Country
          )
        ),
        absolutePanel(
          top = 130,
          left = 180,
          draggable = FALSE,
          mainPanel(plotlyOutput("SunBurst"))
        )
      ),
      tabItem(
        tabName = "DailyDeaths",
        fluidPage(fluidRow(
          column(
            12,
            titlePanel(h1("Daily deaths by Covid-19", align = "center"))
          ),
          column(3, selectInput("var_dd", "Select variable:", choices = colnames(df_url2[c(0:3)]))),
          fluidPage(highchartOutput("plotDD"), width = "100%")
        ))
      ),
      tabItem(
        tabName = "Dens",
        fluidPage(
          fluidRow(column(
            12,
            titlePanel(h1("Regression analysis", align = "center"))
          )),
          fluidRow(
            column(
              3,
              numericInput("num",
                "x-axis cut off:",
                max = 900000000,
                min = 0,
                value = 300000000
              ),
              numericInput(
                "num2",
                "y-axis cut off:",
                max(90000000),
                min = 1,
                value = 300000000
              )
            ),
            column(3,
              offset = 1,
              selectInput("con", "Select continent:",
                choices =
                  join2$Continent[join2$Continent != "0"]
              ),
              selectInput("response", "Select response variable:", choices = colnames(join2[c(3:13, 15:16, 18:22, 2)]))
            ),
            column(3,
              offset = 1,
              selectInput("paraM1", "Select predictor variable:", choices = colnames(join2[c(2:13, 15:16, 18:22)])),
              selectInput("paraM2", "Select 2nd predictor variable:", choices = colnames(join2[c(2:13, 15:16, 18:22)]))
            ),
            fluidRow(column(12,
              plotlyOutput("plotDens"),
              style = "height:10px"
            ))
          )
        )
      )
    )
  )
))
```


## Server

```{r eruptions, echo=TRUE}

server <- function(input, output, session) {
  output$png <- renderPlot({
    pic <- readPNG("Coronavirus.png")
    plot.new()
    grid::grid.raster(pic)
  })
  output$plotDist <- renderHighchart({
    join2 %>%
      hchart(
        "column", hcaes(x = Country, y = NewCases, color = Country)
      ) %>%
      hc_xAxis(categories = join2$Country, decreasing = TRUE)
  })

  output$Boxplot1 <- renderHighchart({
    dat <- data_to_boxplot(df_con, get(input$Box_par), Continent, add_outliers = FALSE, name = paste(input$Box_par))

    highchart() %>%
      hc_xAxis(type = "category") %>%
      hc_add_series_list(dat)
  })

  output$plotDist2 <- renderHighchart({
    hchart(
      df %>% filter(Country != "" & Country != "World" & Country != "Europe" & Country != "Asia" &
        Country != "North America" & Country != "Africa" & Country != "South America" &
        Country != "Oceania" & TotalDeaths != 0), "scatter",
      hcaes(Country, TotalDeaths, z = Country, color = TotalDeaths)
    )
  })

  output$geo2 <-
    renderTmap({
      tm_shape(data_full_states) + tm_polygons(
        "Pop_density",
        palette = "YlGnBu", breaks = c(0, 20, 50, 100, 150, 200, 400, 600, 800, 1000, 2000, 5000, 10000, 20000, 30000), contrast = 1.1, title = "Population density",
        popup.vars = c(
          "Population density/km2 :" = "Pop_density",
          "Total recovered :" = "TotalRecovered",
          "New recovered :" = "NewRecovered",
          "Active cases : " = "ActiveCases",
          "Serious cases :" = "Serious"
        ), id = "NAME"
      ) +
        tm_scale_bar(breaks = c(0, 25, 50, 75, 100), text.size = 1 / 2) +
        tm_text("countryCode", size = 0.6) +
        tmap_mode("view") + tm_view(set.view = c(7, 51, 2))
    })

  output$geo <-
    renderPlotly({
      fig <- plot_geo(dfnoco) %>%
        add_trace(
          z = ~ get(input$par_M),
          color = input$par_M,
          colors = "#e34a33",
          text = ~ paste(
            Country, "\nSelected parameter:", get(input$par_M),
            "\nNew Cases:", NewCases, "\nTotal Deaths:", TotalDeaths,
            "\nCases per 1M:", Cases_1M, "\nDeaths per 1M:", Deaths_1M
          ),
          hoverinfo = "text",
          hoveron = "fill",
          locations = dfnoco$countryCode,
          marker = list(line = country_line_color)
        ) %>%
        colorbar(title = "Color", tickprefix = "") %>%
        layout(
          title = "World map",
          geo = map_options
        )
    })

  output$table <- renderGauge({
    gauge(
      input$var,
      min = 0,
      max = max(df$TotalCases[1:6]),
      label = "Total cases",
      gaugeSectors(
        success = c(0, 10000000),
        warning = c(10000001, 20000000),
        danger = c(20000001, 1111500000)
      )
    )
  })

  output$SunBurst <- renderPlotly({
    plot_ly(
      width = 1170,
      height = 550,
      labels = c(
        "Total Cases",
        "Total Recoverd",
        "Total Deaths",
        "New Cases",
        "New Deaths",
        "Active Cases",
        "Serious Critical",
        "Total Cases per 1M",
        "Total Deaths per 1M"
      ),
      parents = c(
        "",
        "Total Cases",
        "Total Cases",
        "Total Cases",
        "New Cases",
        "Total Cases",
        "Active Cases",
        "Total Cases",
        "Total Cases per 1M"
      ),
      values = c(
        sum(df$TotalCases[df$Country == input$var1]),
        sum(df$TotalRecovered[df$Country == input$var1]),
        sum(df$TotalDeaths[df$Country == input$var1]),
        sum(df$NewCases[df$Country == input$var1]),
        sum(df$NewDeaths[df$Country == input$var1]),
        sum(df$ActiveCases[df$Country == input$var1]),
        sum(df$Serious[df$Country == input$var1]),
        sum(df$Cases_1M[df$Country == input$var1]),
        sum(df$Deaths_1M[df$Country == input$var1])
      ),
      type = "sunburst",

      branchvalues = "remainder"
    )
  })

  output$plotDD <- renderHighchart({
    highchart(type = "stock") %>%
      hc_xAxis(type = "datetime") %>%
      hc_add_series(df_url2[, input$var_dd], type = "line", name = paste(input$var_dd)) %>%
      hc_tooltip(DateFormat = "%d,%m,%Y")
  })

  output$plotDens <- renderPlotly({
    ggplotRegression(lm(
      as.formula(paste(
        input$response, "~", paste(input$paraM1), "- Country", "+", paste(input$paraM2)
      )),
      # as.formula was used in order to allow drop-down menu for predictor variables
      data = subset(
        join2,
        get(input$paraM1) != 0 & get(input$paraM2) != 0 &
          get(input$response) != 0 &
          Continent == input$con |
          input$con == "" & get(input$paraM1) != 0 &
            get(input$response) != 0
      ) %>%
        filter(
          get(input$paraM1) < input$num &
            get(input$response) < input$num2
        )
    ))
  })
}
```

```{r shinyApp, echo=TRUE, paged.print=TRUE}
shinyApp(ui = ui, server = server)
```

